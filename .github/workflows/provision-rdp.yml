name: Provision GitHub RDP (auto-restart)

on:
  workflow_dispatch:

permissions:
  contents: read
  workflows: write

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
    - name: Print header
      run: |
        echo "### GitHub RDP setup started ###"
        echo "NOTE: This runner has limited RAM (~7GB) and ephemeral storage (~14GB)."

    - name: Create RDP user and set password
      run: |
        $user = "ghrdp"
        $pw = "${{ secrets.RDP_PASSWORD }}"
        net user $user $pw /add || echo "user exists"
        net localgroup administrators $user /add
        reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        powershell -Command "Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'"
        echo "RDP user: $user"
        echo "Password is the secret RDP_PASSWORD"

    - name: Optionally install packages (Chrome, 7zip)
      run: |
        choco feature enable -n allowGlobalConfirmation
        choco install -y googlechrome 7zip

    - name: Show network info
      run: ipconfig /all

    - name: Keep alive loop
      run: |
        echo "Keeping alive for 5h50m..."
        timeout /t 21000

    - name: Final note
      run: echo "Workflow complete. Runner will terminate soon."
