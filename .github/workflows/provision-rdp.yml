name: Provision GitHub RDP (auto-restart)

on:
  workflow_dispatch:

permissions:
  contents: read
  workflows: write

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Step 1 - Display info
        run: |
          echo "==== Starting Free RDP Session ===="
          echo "This uses GitHub's Windows runner."
          echo "RAM: ~7GB | Storage: ~14GB | Duration: 6 Hours"

      - name: Step 2 - Create RDP User and Enable RDP
        run: |
          $user = "ghrdp"
          $pw = "${{ secrets.RDP_PASSWORD }}"
          net user $user $pw /add
          net localgroup administrators $user /add
          reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          powershell -Command "Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'"
          echo "✅ RDP Enabled"

      - name: Step 3 - Install Optional Tools
        run: |
          choco feature enable -n allowGlobalConfirmation
          choco install -y googlechrome 7zip notepadplusplus
          echo "✅ Chrome and Notepad++ Installed"

      - name: Step 4 - Network Info
        run: ipconfig

      - name: Step 5 - Keep Alive
        run: timeout /t 21000

      - name: Step 6 - Auto Restart (optional)
        if: always()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          OWNER: ${{ secrets.REPO_OWNER }}
          REPO: ${{ secrets.REPO_NAME }}
          WORKFLOW: ${{ secrets.WORKFLOW_FILE }}
        run: |
          if ("${{ secrets.GH_PAT }}" -ne "") {
            $uri = "https://api.github.com/repos/$env:OWNER/$env:REPO/actions/workflows/$env:WORKFLOW/dispatches"
            $body = @{ ref = "main" } | ConvertTo-Json
            $hdr = @{ Authorization = "token $env:GH_PAT"; "User-Agent" = "gh-actions-self-trigger" }
            Invoke-RestMethod -Uri $uri -Method Post -Headers $hdr -Body $body -ContentType "application/json"
          } else {
            Write-Output "No GH_PAT provided; skipping auto-restart."
          }

      - name: Step 7 - Finish
        run: echo "Workflow complete."
